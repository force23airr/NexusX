# ═══════════════════════════════════════════════════════════════
# NexusX — Staging Overlay
# infrastructure/k8s/overlays/staging/kustomization.yaml
# ═══════════════════════════════════════════════════════════════

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: nexusx-staging

resources:
  - ../../base

namePrefix: stg-

patches:
  # ─── Scale down for staging ───
  - target:
      kind: Deployment
      name: gateway
    patch: |
      - op: replace
        path: /spec/replicas
        value: 1
  - target:
      kind: Deployment
      name: auction-engine
    patch: |
      - op: replace
        path: /spec/replicas
        value: 1
  - target:
      kind: Deployment
      name: ai-router
    patch: |
      - op: replace
        path: /spec/replicas
        value: 1
  - target:
      kind: Deployment
      name: web
    patch: |
      - op: replace
        path: /spec/replicas
        value: 1

  # ─── HPA: lower limits for staging ───
  - target:
      kind: HorizontalPodAutoscaler
      name: gateway-hpa
    patch: |
      - op: replace
        path: /spec/minReplicas
        value: 1
      - op: replace
        path: /spec/maxReplicas
        value: 3
  - target:
      kind: HorizontalPodAutoscaler
      name: auction-engine-hpa
    patch: |
      - op: replace
        path: /spec/minReplicas
        value: 1
      - op: replace
        path: /spec/maxReplicas
        value: 2
  - target:
      kind: HorizontalPodAutoscaler
      name: ai-router-hpa
    patch: |
      - op: replace
        path: /spec/minReplicas
        value: 1
      - op: replace
        path: /spec/maxReplicas
        value: 2

configMapGenerator:
  - name: nexusx-config
    behavior: merge
    literals:
      - SANDBOX_ENABLED=true
      - LOG_LEVEL=debug
      - CLASSIFIER_MODE=rule_based

images:
  - name: nexusx/gateway
    newName: ghcr.io/nexusx/gateway
    newTag: latest
  - name: nexusx/auction-engine
    newName: ghcr.io/nexusx/auction-engine
    newTag: latest
  - name: nexusx/ai-router
    newName: ghcr.io/nexusx/ai-router
    newTag: latest
  - name: nexusx/web
    newName: ghcr.io/nexusx/web
    newTag: latest
